<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Generator</title>
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: "Segoe UI", monospace;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container { width: 100%; max-width: 600px; }
        h2 { text-align: center; color: #58a6ff; }
        
        textarea {
            width: 100%;
            height: 150px;
            background: #161b22;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
        }
        
        button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #2ea043; }
        
        .output-box {
            margin-top: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            display: none; /* Hidden by default */
        }
        
        .output-link {
            word-break: break-all;
            color: #58a6ff;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #30363d;
            border-radius: 4px;
        }

        .copy-btn { background: #1f6feb; margin-top: 5px;}
        .copy-btn:hover { background: #388bfd; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ”— Smart Link Generator</h2>
    <p style="font-size: 0.9em; color: #8b949e;">Paste Mitmachim links (Markdown or Raw).<br>The order doesn't matter; I will sort them by .001, .002...</p>
    
    <textarea id="inputArea" placeholder="Paste links here...&#10;[file.002](.../file.002)&#10;[file.001](.../file.001)"></textarea>
    
    <button onclick="generateLink()">Generate Magic Link</button>

    <div id="resultArea" class="output-box">
        <strong>Your Link:</strong>
        <a id="finalLink" href="#" target="_blank" class="output-link">...</a>
        <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
    </div>
</div>

<script>
    function generateLink() {
        const text = document.getElementById('inputArea').value;
        const resultArea = document.getElementById('resultArea');
        const finalLinkEl = document.getElementById('finalLink');

        // 1. Regex to find the File ID part from the URL
        // Matches anything after "uploads/files/" until a closing parenthesis, quote, or space
        const regex = /\/assets\/uploads\/files\/([a-zA-Z0-9\.\-_\(\)]+)/g;
        
        let matches = [];
        let match;
        
        // Extract all file IDs
        while ((match = regex.exec(text)) !== null) {
            // Clean up: remove closing markdown parenthesis if captured by accident
            let id = match[1].replace(/\)$/, ''); 
            matches.push(id);
        }

        if (matches.length === 0) {
            alert("No valid file links found!");
            return;
        }

        // 2. Remove Duplicates
        matches = [...new Set(matches)];

        // 3. Sort Files (Crucial for split archives)
        // We look for .001, .002 at the end of the string
        matches.sort((a, b) => {
            const extA = a.match(/\.(\d{3})$/);
            const extB = b.match(/\.(\d{3})$/);
            
            // If both have numbers like .001, compare them
            if (extA && extB) {
                return parseInt(extA[1]) - parseInt(extB[1]);
            }
            // Otherwise standard string sort
            return a.localeCompare(b);
        });

        // 4. Guess the final filename
        // Take the first file (e.g. game.7z.001) and remove the .001
        let filename = matches[0];
        if (filename.match(/\.\d{3}$/)) {
            filename = filename.replace(/\.\d{3}$/, '');
            // Also remove the timestamp prefix if you want cleaner names?
            // Optional: Remove timestamp (1769...-filename)
            // filename = filename.substring(filename.indexOf('-') + 1);
        }

        // 5. Construct the URL
        // Get the base URL of your site (assuming generator.html is in same folder as index.html)
        // We replace 'generator.html' with nothing to get the root, or just use origin + pathname logic
        let baseUrl = window.location.href.replace('generator.html', '');
        
        // Ensure it ends with /
        if (!baseUrl.endsWith('/')) baseUrl += '/';

        const params = new URLSearchParams();
        
        // Add ?1=ID, ?2=ID
        matches.forEach((id, index) => {
            params.append((index + 1).toString(), id);
        });

        // Add ?name=filename
        params.append('name', filename);

        const finalUrl = baseUrl + '?' + params.toString();

        // 6. Display Result
        finalLinkEl.textContent = finalUrl;
        finalLinkEl.href = finalUrl;
        resultArea.style.display = 'block';
    }

    function copyToClipboard() {
        const link = document.getElementById('finalLink').textContent;
        navigator.clipboard.writeText(link).then(() => {
            alert("Link copied!");
        });
    }
</script>

</body>
</html>