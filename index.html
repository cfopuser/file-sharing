<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Reassembler</title>
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: "Segoe UI", monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        #status { font-size: 1.2rem; margin-bottom: 20px; }
        #progress-bar {
            width: 300px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        #progress-fill {
            height: 100%;
            background: #238636;
            width: 0%;
            transition: width 0.2s;
        }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="status">Initializing...</div>
    <div id="progress-bar"><div id="progress-fill"></div></div>

    <script>
        // ==============================
        // CONFIG - PASTE YOUR WORKER URL
        // ==============================
        const PROXY_URL = 'https://mitmachim-proxy.yourname.workers.dev/?url=';
        const BASE_DL_URL = 'https://mitmachim.top/assets/uploads/files/';
        // ==============================

        const statusEl = document.getElementById('status');
        const barEl = document.getElementById('progress-bar');
        const fillEl = document.getElementById('progress-fill');

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            
            // 1. Detect parts (1=..., 2=..., 3=...)
            let parts = [];
            let i = 1;
            while(params.has(String(i))) {
                parts.push(params.get(String(i)));
                i++;
            }

            // 2. Detect Desired Filename (Optional param &name=setup.exe)
            // If not provided, we try to guess from the first part, removing .001
            let finalFileName = params.get('name') || "downloaded-file.exe"; 

            if (parts.length === 0) {
                statusEl.textContent = "No file parts found in URL.";
                return;
            }

            statusEl.innerHTML = `Found ${parts.length} parts.<br>Starting download & merge...`;
            barEl.style.display = 'block';

            try {
                // Array to hold the binary chunks
                const fileChunks = [];

                // Download all parts sequentially
                for (let idx = 0; idx < parts.length; idx++) {
                    const fileId = parts[idx];
                    updateProgress(idx, parts.length, `Downloading part ${idx + 1} of ${parts.length}...`);
                    
                    const chunk = await downloadChunk(fileId);
                    fileChunks.push(chunk);

                    // Try to guess name from first part if not set in URL
                    if (idx === 0 && !params.get('name')) {
                        if (chunk.nameGuess) {
                            // Remove trailing .001, .002 etc if present
                            finalFileName = chunk.nameGuess.replace(/\.\d{3}$/, ''); 
                        }
                    }
                }

                updateProgress(1, 1, "Merging files in memory...");
                
                // Merge chunks into one Blob
                const combinedBlob = new Blob(fileChunks.map(c => c.data), { type: "application/octet-stream" });
                
                // Trigger Download
                const url = window.URL.createObjectURL(combinedBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFileName;
                document.body.appendChild(a);
                a.click();
                
                statusEl.innerHTML = `<span style="color:#238636">Complete!</span><br>${finalFileName}`;
                fillEl.style.width = '100%';
                
                setTimeout(() => window.URL.revokeObjectURL(url), 5000);

            } catch (err) {
                statusEl.textContent = "Error: " + err.message;
                statusEl.style.color = "red";
            }
        };

        async function downloadChunk(fileId) {
            const target = BASE_DL_URL + fileId;
            const res = await fetch(PROXY_URL + encodeURIComponent(target));
            
            if (!res.ok) throw new Error(`Failed to load file ID ${fileId}`);

            // Get buffer
            const buffer = await res.arrayBuffer();
            
            // Get filename from header for guessing later
            let nameGuess = null;
            const disposition = res.headers.get('Content-Disposition');
            if (disposition && disposition.includes('filename=')) {
                const match = disposition.match(/filename="?([^"]+)"?/);
                if (match) nameGuess = match[1];
            }

            return { data: buffer, nameGuess: nameGuess };
        }

        function updateProgress(current, total, text) {
            const pct = Math.round((current / total) * 100);
            fillEl.style.width = pct + '%';
            statusEl.innerHTML = text + ` <span class="blink">_</span>`;
        }
    </script>
</body>
</html>