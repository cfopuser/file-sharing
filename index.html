<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Merger</title>
    <style>
        body { background: #0d1117; color: #eee; font-family: monospace; text-align: center; padding-top: 50px; }
        #log { margin-top: 20px; color: #8b949e; }
        .error { color: #ff7b72; }
        .success { color: #238636; font-weight: bold; }
        #bar-container { width: 300px; height: 10px; background: #333; margin: 20px auto; display: none; }
        #bar-fill { height: 100%; background: #238636; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <h2>File Merger</h2>
    <div id="bar-container"><div id="bar-fill"></div></div>
    <div id="log">Waiting...</div>

    <script>
        // ==========================================
        // CONFIG: PASTE YOUR WORKER URL HERE
        // ==========================================
        const PROXY_URL = 'https://mitm-proxy.cfop33user.workers.dev/?url='; 
        const BASE_DL_URL = 'https://mitmachim.top/assets/uploads/files/';
        // ==========================================

        const logEl = document.getElementById('log');
        const barFill = document.getElementById('bar-fill');
        const barCont = document.getElementById('bar-container');

        function log(msg, type='') {
            logEl.innerHTML = `<div class="${type}">${msg}</div>`;
            console.log(msg);
        }

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const parts = [];
            let i = 1;
            
            // Collect parts 1, 2, 3...
            while(params.has(String(i))) {
                parts.push(params.get(String(i)));
                i++;
            }

            if(parts.length === 0) {
                log("No file parts found (checked ?1=, ?2=...)", "error");
                return;
            }

            const fileName = params.get('name') || "merged-file.exe";
            barCont.style.display = 'block';

            try {
                const chunks = [];
                
                for(let k=0; k < parts.length; k++) {
                    const percent = Math.round((k / parts.length) * 100);
                    barFill.style.width = percent + '%';
                    log(`Downloading part ${k+1} of ${parts.length}...`);
                    
                    const chunk = await downloadPart(parts[k]);
                    chunks.push(chunk);
                }

                barFill.style.width = '100%';
                log("Merging files...", "success");

                // Combine
                const blob = new Blob(chunks, { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);

                // Download
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                log(`Saved as: ${fileName}`, "success");
                setTimeout(() => window.URL.revokeObjectURL(url), 10000);

            } catch (error) {
                log(`ERROR: ${error.message}`, "error");
            }
        }

        async function downloadPart(fileId) {
            // Construct the exact URL
            const fileUrl = BASE_DL_URL + fileId;
            
            // Encode it properly for the worker
            const workerRequestUrl = PROXY_URL + encodeURIComponent(fileUrl);
            
            // Debug log to console (F12)
            console.log("Fetching:", workerRequestUrl);

            const response = await fetch(workerRequestUrl, {
                method: 'GET',
                mode: 'cors' // Explicitly request CORS
            });

            if (!response.ok) {
                throw new Error(`Server Error ${response.status} for file ID ${fileId}`);
            }

            return await response.arrayBuffer();
        }

        window.onload = init;
    </script>
</body>
</html>