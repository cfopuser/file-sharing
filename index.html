<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Downloader</title>
    <style>
        body { 
            margin: 0;
            padding: 0;
            height: 100vh;
            background: #0d1117; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #bar-container { 
            width: 300px; 
            height: 6px; 
            background: #21262d; 
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            /* Initially hidden until script runs if desired, or keep visible */
            opacity: 0; 
            transition: opacity 0.5s ease;
        }

        #bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #2ea043, #3fb950); 
            width: 0%; 
            transition: width 0.2s ease-out;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.4);
        }
    </style>
</head>
<body>

    <div id="bar-container"><div id="bar-fill"></div></div>

    <script>

        const PROXY_URL = 'https://mitm-proxy.cfop33user.workers.dev/?url='; 
        const BASE_DL_URL = 'https://mitmachim.top/assets/uploads/files/';


        const barFill = document.getElementById('bar-fill');
        const barCont = document.getElementById('bar-container');

        // Modified log function: Only logs to console (F12) since UI text is removed
        function log(msg, type='') {
            console.log(`[${type || 'INFO'}] ${msg}`);
        }

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const parts = [];
            let i = 1;
            
            // Collect parts 1, 2, 3...
            while(params.has(String(i))) {
                parts.push(params.get(String(i)));
                i++;
            }

            if(parts.length === 0) {
                log("No file parts found (checked ?1=, ?2=...)", "error");
                return;
            }

            const fileName = params.get('name') || "merged-file.exe";
            
            // Show the bar now that we have work to do
            barCont.style.opacity = '1';

            try {
                const chunks = [];
                
                for(let k=0; k < parts.length; k++) {
                    // Update visual progress
                    const percent = Math.round((k / parts.length) * 100);
                    barFill.style.width = percent + '%';
                    
                    log(`Downloading part ${k+1} of ${parts.length}...`);
                    
                    const chunk = await downloadPart(parts[k]);
                    chunks.push(chunk);
                }

                barFill.style.width = '100%';
                log("Merging files...", "success");

                // Combine
                const blob = new Blob(chunks, { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);

                // Download
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                log(`Saved as: ${fileName}`, "success");
                
                // Optional: Fade out bar after download starts
                setTimeout(() => {
                    barCont.style.opacity = '0';
                    window.URL.revokeObjectURL(url);
                }, 2000);

            } catch (error) {
                log(`ERROR: ${error.message}`, "error");
                // Turn bar red on error
                barFill.style.background = '#ff7b72';
                barFill.style.boxShadow = '0 0 10px rgba(255, 123, 114, 0.4)';
            }
        }

        async function downloadPart(fileId) {
            const fileUrl = BASE_DL_URL + fileId;
            const workerRequestUrl = PROXY_URL + encodeURIComponent(fileUrl);
            
            console.log("Fetching:", workerRequestUrl);

            const response = await fetch(workerRequestUrl, {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                throw new Error(`Server Error ${response.status} for file ID ${fileId}`);
            }

            return await response.arrayBuffer();
        }

        window.onload = init;
    </script>
</body>
</html>